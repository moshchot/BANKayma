<?xml version="1.0" encoding="utf-8" ?>
<!-- Copyright 2023 Hunki Enterprises BV
     License AGPL-3.0 or later (https://www.gnu.org/licenses/agpl). -->
<odoo>
    <record id="view_dashboard_qweb" model="ir.ui.view">
        <field name="model">account.move</field>
        <field name="type">qweb</field>
        <field name="arch" type="xml">
            <t t-set="internal_ml" t-value="env['account.move.line'].browse([])" />
            <t t-set="incoming_ml" t-value="env['account.move.line'].browse([])" />
            <t t-set="outgoing_ml" t-value="env['account.move.line'].browse([])" />
            <t t-set="internal" t-value="model.browse([])" />
            <t t-set="incoming" t-value="model.browse([])" />
            <t t-set="outgoing" t-value="model.browse([])" />
            <t t-foreach="records" t-as="record">
                <t
                    t-if="record.auto_generated or model.search([('auto_invoice_id', '=', record.id)])"
                >
                    <t t-set="internal" t-value="internal + record" />
                    <t
                        t-set="internal_ml"
                        t-value="internal_ml + record.mapped('line_ids')"
                    />
                </t>
                <t t-elif="record.move_type in ('out_invoice', 'in_refund')">
                    <t t-set="incoming" t-value="incoming + record" />
                    <t
                        t-set="incoming_ml"
                        t-value="incoming_ml + record.mapped('line_ids')"
                    />
                </t>
                <t t-elif="record.move_type in ('in_invoice', 'out_refund')">
                    <t t-set="outgoing" t-value="outgoing + record" />
                    <t
                        t-set="outgoing_ml"
                        t-value="outgoing_ml + record.mapped('line_ids')"
                    />
                </t>
            </t>
            <t t-set="all_incoming" t-value="sum(incoming.mapped('amount_total'))" />
            <t
                t-set="all_paid_incoming"
                t-value="sum(incoming.mapped('bankayma_amount_paid'))"
            />
            <t t-set="all_outgoing" t-value="sum(outgoing.mapped('amount_total'))" />
            <t
                t-set="all_paid_outgoing"
                t-value="sum(outgoing.mapped('bankayma_amount_paid'))"
            />
            <t t-set="all_internal" t-value="sum(internal.mapped('amount_total'))" />
            <t
                t-set="all_paid_internal"
                t-value="sum(internal.mapped('bankayma_amount_paid'))"
            />
            <div class="container text-center p-3">
                <div class="row">
                    Here links to the moves being used to calculate the different
                    values:
                    <a
                        type="action"
                        data-model="account.move"
                        t-att-data-domain="[('id', 'in', incoming.ids)]"
                    >
                        Incoming
                    </a>
                    <a
                        type="action"
                        data-model="account.move"
                        t-att-data-domain="[('id', 'in', outgoing.ids)]"
                    >
                        Outgoing
                    </a>

                    <a
                        type="action"
                        data-model="account.move"
                        t-att-data-domain="[('id', 'in', internal.ids)]"
                    >
                        Internal
                    </a>
                </div>
                <div class="row">
                    <div class="col border bg-light">
                        <h1>Balance</h1>
                        <a
                            type="action"
                            data-model="account.move"
                            t-att-data-domain="[('id', 'in', (incoming + outgoing).ids)]"
                            t-esc="all_paid_incoming - all_paid_outgoing"
                            t-options='{"widget": "monetary", "display_currency": res_company.currency_id}'
                        />
                        <div>
                            <t
                                t-esc="all_incoming - all_outgoing"
                                t-options='{"widget": "monetary", "display_currency": res_company.currency_id}'
                            />
                            expected
                        </div>
                    </div>
                    <div class="col border bg-light">
                        <h1>Income</h1>
                        <span
                            t-esc="all_paid_incoming"
                            t-options='{"widget": "monetary", "display_currency": res_company.currency_id}'
                        />
                        <div>
                            Unpaid:
                            <t
                                t-esc="all_incoming - all_paid_incoming"
                                t-options='{"widget": "monetary", "display_currency": res_company.currency_id}'
                            />
                        </div>
                    </div>
                    <div class="col border bg-light">
                        <h1>Expenses</h1>
                        <span
                            t-esc="all_paid_outgoing"
                            t-options='{"widget": "monetary", "display_currency": res_company.currency_id}'
                        />
                        <div>
                            Unpaid:
                            <t
                                t-esc="all_outgoing - all_paid_outgoing"
                                t-options='{"widget": "monetary", "display_currency": res_company.currency_id}'
                            />
                        </div>
                    </div>
                    <div class="col border bg-light">
                        <h1>Internal</h1>
                        <span
                            t-esc="all_paid_internal"
                            t-options='{"widget": "monetary", "display_currency": res_company.currency_id}'
                        />
                        <div>
                            Unpaid:
                            <t
                                t-esc="all_internal - all_paid_internal"
                                t-options='{"widget": "monetary", "display_currency": res_company.currency_id}'
                            />
                        </div>
                    </div>
                </div>
                <div class="row">
                    <h1>Projects</h1>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Name</th>
                                <th>Income</th>
                                <th>Expenses</th>
                                <th>Internal</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="records.mapped('company_id')" t-as="company">
                                <tr>
                                    <t
                                        t-set="moves"
                                        t-value="incoming_ml.filtered(lambda x: x.company_id == company)"
                                    />
                                    <t
                                        t-set="incoming"
                                        t-value="sum(moves.mapped('balance'))"
                                    />
                                    <t
                                        t-set="outgoing"
                                        t-value="sum(moves.mapped('balance'))"
                                    />
                                    <td>
                                        <a
                                            type="action"
                                            data-model="account.move"
                                            t-att-data-domain="[('id', 'in', moves.ids)]"
                                            t-esc="company.code"
                                        />
                                    </td>
                                    <td t-esc="company.name" />
                                    <td
                                        t-esc="incoming"
                                        t-options='{"widget": "monetary", "display_currency": res_company.currency_id}'
                                    />
                                    <td
                                        t-esc="outgoing"
                                        t-options='{"widget": "monetary", "display_currency": res_company.currency_id}'
                                    />
                                    <td
                                        t-esc="sum(internal_ml.filtered(lambda x: x.product_id == product).mapped('balance'))"
                                        t-options='{"widget": "monetary", "display_currency": res_company.currency_id}'
                                    />
                                    <td
                                        t-esc="incoming - outgoing"
                                        t-options='{"widget": "monetary", "display_currency": res_company.currency_id}'
                                    />
                                </tr>
                            </t>
                        </tbody>
                    </table>
                </div>
                <div class="row">
                    <div class="col">
                        <h1>Products</h1>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Paid</th>
                                    <th>Unpaid</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t
                                    t-foreach="records.mapped('line_ids.product_id').sorted(lambda x: x.default_code or '')"
                                    t-as="product"
                                >
                                    <tr t-if="product">
                                        <t
                                            t-set="amount"
                                            t-value="sum(incoming_ml.filtered(lambda x: x.product_id == product).mapped('balance'))"
                                        />
                                        <t
                                            t-set="amount_paid"
                                            t-value="sum(incoming_ml.filtered(lambda x: x.product_id == product and x.reconciled).mapped('balance'))"
                                        />
                                        <t
                                            t-set="amount_unpaid"
                                            t-value="amount - amount_paid"
                                        />
                                        <td t-esc="product.display_name" />
                                        <td
                                            t-esc="amount_paid"
                                            t-options='{"widget": "monetary", "display_currency": res_company.currency_id}'
                                        />
                                        <td
                                            t-esc="amount_unpaid"
                                            t-options='{"widget": "monetary", "display_currency": res_company.currency_id}'
                                        />
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                    <div class="col">
                        <h1>Customers/Suppliers</h1>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Rank</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t
                                    t-foreach="records.mapped('line_ids.partner_id').sorted(lambda x: -x.customer_rank - x.supplier_rank)"
                                    t-as="partner"
                                >
                                    <tr t-if="partner">
                                        <td>
                                            <a
                                                type="action"
                                                t-att-data-model="partner._name"
                                                t-att-data-res-id="partner.id"
                                                t-esc="partner.name"
                                            />
                                        </td>
                                        <td
                                            t-esc="partner.customer_rank + partner.supplier_rank"
                                        />
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </field>
    </record>

    <record id="action_dashboard" model="ir.actions.act_window">
        <field name="name">Dashboard</field>
        <field name="res_model">account.move</field>
        <field name="view_mode">qweb</field>
        <field name="view_id" ref="view_dashboard_qweb" />
    </record>

    <record id="bankayma_base.menu_bankayma_root" model="ir.ui.menu">
        <field name="action" ref="action_dashboard" />
    </record>
</odoo>
